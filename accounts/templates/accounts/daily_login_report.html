{% extends 'base.html' %}
{% load static %}

{% block title %}
  Daily Student Login Report
{% endblock %}

{% block content %}
  <!-- Active Student Count Display -->
  <div class="row">
    <div class="col-lg-12">
      <div class="alert alert-info text-center">
        <h4>Total Number of Logged-In Students: <span id="totalStudents">0</span></h4>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <div class="col-lg-12">
      <div class="mb-3">
        <label for="datePicker" class="form-label">Select Date:</label>
        <input type="date" id="datePicker" class="form-control w-auto d-inline-block" value="{{ date|default:'' }}" />
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Daily Student Login Report</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table mb-0 data-table fs-10 table-bordered" data-datatables="data-datatables">
              <thead class="bg-primary">
                <tr>
                  <th>#</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Login Count</th>
                </tr>
              </thead>
              <tbody id="studentTableBody" class="text-center">
                <!-- Data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const datePicker = document.getElementById('datePicker')
      const studentTableBody = document.getElementById('studentTableBody')
      const totalStudentsSpan = document.getElementById('totalStudents')
    
      // Set the default date to today
      function getCurrentDate() {
        const today = new Date()
        return today.toISOString().split('T')[0] // Formats as YYYY-MM-DD
      }
    
      datePicker.value = getCurrentDate()
    
      // Function to fetch and display data
      function fetchStudentLogins(date) {
        fetch(`/get_student_logins_json?date=${date}`)
          .then((response) => response.json())
          .then((data) => {
            studentTableBody.innerHTML = '' // Clear previous data
            totalStudentsSpan.textContent = data.total_students_logged_in
    
            data.students_logged_in.forEach((student, index) => {
              const row = `
                                                                                                            <tr>
                                                                                                                <td>${index + 1}</td> 
                                                                                                                <td>${student.user__first_name}</td>
                                                                                                                <td>${student.user__last_name}</td>
                                                                                                                <td>${student.user__email}</td>
                                                                                                                <td>${student.user__profile__role__name}</td>
                                                                                                                <td>${student.login_count}</td>
                                                                                                            </tr>
                                                                                                        `
              studentTableBody.innerHTML += row
            })
          })
          .catch((error) => console.error('Error fetching student login data:', error))
      }
    
      // Fetch initial data with today's date
      fetchStudentLogins(datePicker.value)
    
      // Update table on date change
      datePicker.addEventListener('change', function () {
        fetchStudentLogins(this.value)
      })
    })
  </script>
{% endblock %}
