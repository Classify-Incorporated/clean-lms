<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <title>Classroom Mode - {{ subject.subject_name }}</title>
    <link rel="stylesheet" href="{% static 'assets/plugins/fontawesome-free/css/all.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/dist/css/adminlte.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/dist/css/settings.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/dist/css/custom_modal.css' %}" />
    <link rel="stylesheet" href="{% static 'css/subject_details.css' %}" />

    <link rel="icon" type="image/png" href="{% static 'favicon.ico' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- Bootstrap Select -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css" />
    <!-- Include FullCalendar CSS and JS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
    <style>
      /* Divider Section */
      .lesson-divider-section {
        margin-bottom: 20px;
      }

      .lesson-divider {
        border: 2px solid #ccc;
        width: 100%;
        margin: 0 auto;
      }

      .lesson-title-header {
        font-weight: bold;
        color: #555;
        margin-top: -15px;
        background: #f8f9fa;
        display: inline-block;
        padding: 5px 15px;
        border-radius: 10px;
        border: 2px solid #ccc;
      }

      /* Weekly Lessons Container */
      .lesson-container {
        display: flex;
        flex-wrap: nowrap;  /* Ensure all days are in one row */
        overflow-x: auto;   /* Enable scrolling if content overflows */
        gap: 10px;
        padding: 10px;
        justify-content: center;
      }

      /* Lesson Column with Pastel Colors */
      .lesson-column {
        flex: 1;
        min-width: 180px; /* Ensures uniform width */
        text-align: center;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(200, 200, 200, 0.3);
      }

      /* Soft Pastel Background Colors for Each Day */
      .lesson-column:nth-child(1) { background: #ffebee; } /* Light Red */
      .lesson-column:nth-child(2) { background: #f3e5f5; } /* Light Purple */
      .lesson-column:nth-child(3) { background: #e8f5e9; } /* Light Green */
      .lesson-column:nth-child(4) { background: #e3f2fd; } /* Light Blue */
      .lesson-column:nth-child(5) { background: #fff3e0; } /* Light Orange */
      .lesson-column:nth-child(6) { background: #fce4ec; } /* Light Pink */
      .lesson-column:nth-child(7) { background: #ede7f6; } /* Light Violet */

      /* Lesson Day */
      .lesson-day {
        font-weight: bold;
        background: rgba(0, 0, 0, 0.1); /* Slight transparency */
        color: #333;
        padding: 8px;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      /* Lesson Date */
      .lesson-date {
        font-size: 12px;
        color: #666;
        background: rgba(0, 0, 0, 0.1);
        padding: 3px 6px;
        border-radius: 4px;
        margin-left: 5px;
      }

      /* Lesson Card - Ensuring Equal Width & Height */
      .lesson-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        border: 2px solid rgba(200, 200, 200, 0.3);
        padding: 10px;
        margin-bottom: 10px;
        width: 100%; /* Ensures consistency */
        min-height: 160px; /* Set minimum height */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-around; /* Distributes content evenly */
        transition: background 0.3s, transform 0.2s;
      }

      .lesson-card:hover {
        background: rgba(250, 250, 250, 0.9);
        transform: translateY(-3px);
      }

      /* Lesson Icon */
      .lesson-icon i {
        font-size: 36px;
        margin-bottom: 10px;
      }

      /* Lesson Title */
      .lesson-title {
        font-size: 14px;
        font-weight: bold;
      }

      /* Lesson Time */
      .lesson-time {
        font-size: 12px;
        color: #333;
      }

      /* Lesson Actions */
      .lesson-actions .btn {
        margin: 5px;
        font-size: 12px;
      }
      .sortable-ghost {
        opacity: 0.5;
        background: rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <!-- Classroom Header -->
    <div class="classroom-header fade-in">
      <div class="header-content">
        <h1>Classroom Mode: {{ subject.subject_name }}</h1>
        <a href="{% url 'subjectDetail' subject.id %}" class="btn btn-light">Exit Classroom Mode</a>
      </div>
        <!-- Ongoing Activities -->
        <div class='ml-2'>
          {% if is_teacher %}
            <a href="javascript:void(0);" class="btn btn-primary float-right" id="classActionButton" data-subject-id="{{ subject.id }}" data-is-active="false"><i class="fas fa-chalkboard-teacher"></i> Start Class</a>
          {% endif %}
        </div>
    </div>

    <div class="classroom-container fade-in">

      <!-- Teacher's section -->
      {% if is_teacher %}
        {% now 'Y-m-d' as today_date %}
        {% if selected_semester.start_date|date:'Y-m-d' <= today_date and selected_semester.end_date|date:'Y-m-d' >= today_date %}
        <div class="row justify-content-center mb-4">
          <div class="col-md-12">
            <div class="d-flex flex-wrap justify-content-center">
              <a class="btn-tablet-mode add" data-toggle="modal" data-target="#addActivityLessonModalCM">
                <i class="fas fa-plus"></i>
                <span>Add Activity or Lesson</span>
              </a>                
              <a href="{% url 'activityListCM' subject.id %}" class="btn-tablet-mode list">
                <i class="fas fa-tasks"></i>
                <span>Activity List</span>
              </a>
              <a class="btn-tablet-mode copy" onclick="openCopyActivityModal('{{ subject.id }}')">
                <i class="fas fa-copy"></i>
                <span>Copy Activities</span>
              </a>
              <button class="btn-tablet-mode lesson" onclick="openCopyLessonModal('{{ subject.id }}')">
                <i class="fas fa-book"></i>
                <span>Copy Lessons</span>
              </button>
              <a href="{% url 'subjectStudentListCM' subject.id %}?semester={{ selected_semester_id }}" class="btn-tablet-mode students">
                <i class="fas fa-users"></i>
                <span>View Students</span>
              </a>
              <a href="{% url 'attendanceListCM' subject.id %}" class="btn-tablet-mode attendance">
                <i class="fas fa-list-alt"></i>
                <span>Attendance</span>
              </a>
            </div>
          </div>
        </div>            
        {% endif %}
      {% endif %}

      <!-- Lessons Section -->
      <div class="container mt-4 col-md-12">
        <!-- Weekly Lessons Header -->
        <div class="lesson-divider-section text-center">
            <hr class="lesson-divider">
            <h4 class="lesson-title-header">üìö Weekly Lessons</h4>
        </div>
    
        <!-- Weekly Schedule Row -->
        <div class="lesson-container">
            <!-- Sunday -->
            <div class="lesson-column" id="sunday-column">
                <h5 class="lesson-day">Sunday <span class="lesson-date" id="sunday-date"></span></h5>
            </div>
    
            <!-- Monday -->
            <div class="lesson-column" id="monday-column">
                <h5 class="lesson-day">Monday <span class="lesson-date" id="monday-date"></span></h5>
                <div class="lesson-card" id="monday-lesson-1" data-module-id="1">
                    <div class="lesson-icon"><i class="far fa-file-alt text-secondary"></i></div>
                    <div class="lesson-title">Data Structures</div>
                    <div class="lesson-time">‚è∞ 10:00 AM - 11:30 AM</div>
                </div>
                <div class="lesson-card" id="monday-lesson-2" data-module-id="1">
                    <div class="lesson-icon"><i class="far fa-file-pdf text-danger"></i></div>
                    <div class="lesson-title">Introduction to Programming</div>
                    <div class="lesson-time">‚è∞ 9:00 AM - 10:30 AM</div>
                </div>
            </div>
    
            <!-- Tuesday -->
            <div class="lesson-column" id="tuesday-column">
                <h5 class="lesson-day">Tuesday <span class="lesson-date" id="tuesday-date"></span></h5>
                <div class="lesson-card" id="tuesday-lesson-1" data-module-id="1">
                    <div class="lesson-icon"><i class="far fa-file-video text-primary"></i></div>
                    <div class="lesson-title">Object-Oriented Programming</div>
                    <div class="lesson-time">‚è∞ 1:00 PM - 2:30 PM</div>
                </div>
            </div>
    
            <!-- Wednesday -->
            <div class="lesson-column" id="wednesday-column">
                <h5 class="lesson-day">Wednesday <span class="lesson-date" id="wednesday-date"></span></h5>
                <div class="lesson-card" id="wednesday-lesson-1" data-module-id="1">
                    <div class="lesson-icon"><i class="far fa-file-word text-info"></i></div>
                    <div class="lesson-title">Algorithms</div>
                    <div class="lesson-time">‚è∞ 2:00 PM - 3:30 PM</div>
                </div>
            </div>
    
            <!-- Thursday -->
            <div class="lesson-column" id="thursday-column">
                <h5 class="lesson-day">Thursday <span class="lesson-date" id="thursday-date"></span></h5>
                <div class="lesson-card" id="thursday-lesson-1" data-module-id="1">
                    <div class="lesson-icon"><i class="far fa-file-excel text-success"></i></div>
                    <div class="lesson-title">Database Management</div>
                    <div class="lesson-time">‚è∞ 3:00 PM - 4:30 PM</div>
                </div>
            </div>
    
            <!-- Friday -->
            <div class="lesson-column" id="friday-column">
                <h5 class="lesson-day">Friday <span class="lesson-date" id="friday-date"></span></h5>
                <div class="lesson-card" id="friday-lesson-1" data-module-id="1">
                    <div class="lesson-icon"><i class="far fa-file-powerpoint text-warning"></i></div>
                    <div class="lesson-title">Web Development</div>
                    <div class="lesson-time">‚è∞ 4:00 PM - 5:30 PM</div>
                </div>
                <div class="lesson-card" id="friday-lesson-2" data-module-id="1">
                    <div class="lesson-icon"><i class="far fa-file-archive text-secondary"></i></div>
                    <div class="lesson-title">Software Engineering</div>
                    <div class="lesson-time">‚è∞ 5:00 PM - 6:30 PM</div>
                </div>
            </div>
    
            <!-- Saturday -->
            <div class="lesson-column" id="saturday-column">
                <h5 class="lesson-day">Saturday <span class="lesson-date" id="saturday-date"></span></h5>
            </div>
        </div>
    </div>
    
    </div>

    <!-- Bootstrap Modal for Adding Activity or Lesson -->
    <div class="modal fade" id="addActivityLessonModalCM" tabindex="-1" role="dialog" aria-labelledby="addActivityLessonModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addActivityLessonModalLabel">Add an Activity or Lesson</h5>
            <button type="button" id="closeAddActivityLessonModalCMBtn" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>            
          </div>
          <div class="modal-body">
            <!-- Button-app layout for all content types with colored icons and fixed margin -->
            <div class="container">
              <div class="row justify-content-center">
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="selectActivityTypeAndRedirect('Assignment', {{ subject.id }}, {{ assignment_activity_type_id }}, true)">
                    <i class="fas fa-check-square text-primary"></i> Assignment
                  </a>
                </div>
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="openAttendanceModal('{{ subject.id }}')">
                    <i class="fas fa-user-check text-success"></i> Attendance
                  </a>
                </div>
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="selectActivityTypeAndRedirect('Participation', {{ subject.id }}, {{ participation_activity_type_id }}, true)">
                    <i class="fas fa-users text-danger"></i> Participation
                  </a>
                </div>
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="openModuleModalClassroom({{ subject.id }}, 'lesson')">
                    <i class="fas fa-book text-warning"></i> Lesson
                  </a>              
                </div>
              </div>
    
              <div class="row justify-content-center">
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" data-toggle="modal" data-target="#teamsSignInModal">
                    <i class="fas fa-video text-primary"></i> Video Conference
                  </a>
                </div>
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="selectActivityTypeAndRedirect('Quiz', {{ subject.id }}, {{ quiz_activity_type_id }}, true)">
                    <i class="fas fa-question-circle text-danger"></i> Quiz
                  </a>
                </div>
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="selectActivityTypeAndRedirect('Exam', {{ subject.id }}, {{ exam_activity_type_id }}, true)">
                    <i class="fas fa-file-alt text-info"></i> Exam
                  </a>
                </div>
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="selectActivityTypeAndRedirect('Special', {{ subject.id }}, {{ special_activity_type_id }}, true)">
                    <i class="fas fa-book text-info"></i> Special Activity
                  </a>
                </div>
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="openModuleModalClassroom({{ subject.id }}, 'url')">
                    <i class="fas fa-link text-purple"></i> URL
                  </a>
                </div>
                <div class="col-md-3 mb-3 d-flex justify-content-center">
                  <a href="#" class="btn btn-app" onclick="openModuleModalClassroom({{ subject.id }}, 'embed')">
                    <i class="fas fa-code text-purple"></i> Embed Code
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
  

    <!-- Custom Modal for Adding Participation -->
    <div id="participationModal" class="custom-modal">
      <div class="custom-modal-header d-flex justify-content-between">
        <h5>Select Participation Details</h5>
        <button class="close-btn" id="closeParticipationModalBtn"></button>
      </div>
      <div class="custom-modal-body" id="participationModalBody"></div>
    </div>
    <div id="participationModalBackdrop" class="custom-modal-backdrop"></div>

    <!-- Custom Modal for Adding Module -->
    <div id="moduleModal" class="custom-modal">
      <div class="custom-modal-header d-flex justify-content-between">
        <h5 class="text-dark">Add Lesson</h5>

        <button class="close-btn" id="closeModuleModalBtn"></button>
      </div>
      <div class="custom-modal-body" id="moduleModalBody"></div>
    </div>
    <div id="moduleModalBackdrop" class="custom-modal-backdrop"></div>

    <!-- Copy Lessons Modal -->
    <div id="copyLessonModal" class="custom-modal">
      <div class="custom-modal-header d-flex justify-content-between">
        <h5 class="text-dark">Copy Lessons</h5>
        <button class="close-btn" id="closeCopyLessonModalBtn"></button>
      </div>
      <div class="custom-modal-body" id="copyLessonModalBody"></div>
    </div>
    <div id="copyLessonModalBackdrop" class="custom-modal-backdrop"></div>

    <!-- Custom Modal for Copying Activities -->
    <div id="copyActivityModal" class="custom-modal">
      <div class="custom-modal-header d-flex justify-content-between">
        <h5 class="text-dark">Copy Activities</h5>
        <button class="close-btn" id="closeCopyActivityModalBtn"></button>
      </div>
      <div class="custom-modal-body" id="copyActivityModalBody"></div>
    </div>
    <div id="copyActivityModalBackdrop" class="custom-modal-backdrop"></div>

    <!-- Modal for Microsoft Teams Sign-in -->
    <div class="modal" id="teamsSignInModal" tabindex="-1" role="dialog" aria-labelledby="teamsSignInModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content card-style-modal">
          <div class="modal-header">
            <h5 class="modal-title" id="teamsSignInModalLabel">Sign in to Microsoft Teams</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body text-center">
            <p>To start your Microsoft Teams meeting, sign in using your school account.</p>
            <a href="https://teams.microsoft.com" target="_blank" class="btn btn-primary">Sign in to Microsoft Teams</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="custom-modal">
      <div class="custom-modal-header d-flex justify-content-between">
        <h5 class="text-dark">Record Attendance</h5>
        <button class="close-btn" id="closeAttendanceModalBtn"></button>
      </div>
      <div class="custom-modal-body" id="attendanceModalBody"></div>
    </div>
    <div id="attendanceModalBackdrop" class="custom-modal-backdrop"></div>

    <script src="{% static 'assets/plugins/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'assets/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'assets/plugins/chart.js/Chart.min.js' %}"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SortableJS for drag-and-drop functionality (Frontend Only) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

    {% comment %}classroom_mode code{% endcomment %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'js/classroom-mode.js' %}"></script>
    <script src="{% static 'js/classroom-mode-full-screen.js' %}"></script>
    <script src="{% static 'js/file-validation.js' %}"></script>
    <script src="{% static 'js/modal.js' %}"></script>
    <!-- Bootstrap Select -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="{% static 'js/deactivate-classroom-mode.js' %}"></script>
    <script src="{% static 'js/file-validation.js' %}"></script>

    <script>
      function confirmDeleteLesson(moduleId) {
        Swal.fire({
          title: 'Are you sure?',
          text: 'This lesson will be deleted and cannot be recovered!',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, delete it!',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            // Redirect to the delete URL
            window.location.href = `/deleteModule/${moduleId}/`
          }
        })
      }
    </script>

    <script>
        const createPieChart = (chartId, labels, data, links, noDataId) => {
          const ctx = document.getElementById(chartId).getContext('2d');
          
          // Fetch the root styles (CSS variables) and get specific colors
          const rootStyles = getComputedStyle(document.documentElement);
          const primaryColor = rootStyles.getPropertyValue('--primary').trim();
          const warningColor = rootStyles.getPropertyValue('--warning').trim();
          const successColor = rootStyles.getPropertyValue('--success').trim();
          const infoColor = rootStyles.getPropertyValue('--info').trim();
          const dangerColor = rootStyles.getPropertyValue('--danger').trim();
          const secondaryColor = rootStyles.getPropertyValue('--secondary').trim();
        
          const colors = [primaryColor, warningColor, successColor, infoColor, dangerColor, secondaryColor];
        
          if (data.length > 0) {
            const chart = new Chart(ctx, {
              type: 'pie',
              data: {
                labels: labels.map(label => label.length > 20 ? label.substring(0, 20) + '...' : label), // Truncate long labels
                datasets: [{
                  data: data,
                  backgroundColor: colors, // Use the root colors
                  borderColor: colors, // Use the root colors for border as well
                  borderWidth: 2
                }],
              },
              options: {
                onClick: (event, array) => {
                  if (array.length) {
                    const index = array[0].index;
                    window.location.href = links[index];
                  }
                },
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'left',  
                    align: 'start',    
                    labels: {
                      usePointStyle: true,
                      padding: 20,
                      font: {
                        size: 12
                      },
                      generateLabels: function(chart) {
                        const originalLabels = chart.data.labels;
                        return originalLabels.map((label, i) => ({
                          text: label.length > 20 ? label.substring(0, 20) + '...' : label,
                          fillStyle: chart.data.datasets[0].backgroundColor[i],
                          hidden: chart.getDatasetMeta(0).data[i].hidden,
                          index: i,
                          fullText: label // Store full label text
                        }));
                      }
                    },
                    onHover: function(event, legendItem) {
                      // Show full text in a tooltip when hovering over the label
                      const tooltipDiv = document.createElement('div');
                      tooltipDiv.id = 'legendTooltip';
                      tooltipDiv.style.position = 'absolute';
                      tooltipDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                      tooltipDiv.style.color = '#fff';
                      tooltipDiv.style.padding = '5px';
                      tooltipDiv.style.borderRadius = '4px';
                      tooltipDiv.style.pointerEvents = 'none';
                      tooltipDiv.style.zIndex = 1000;
                      tooltipDiv.innerHTML = legendItem.fullText;
                      
                      document.body.appendChild(tooltipDiv);
        
                      document.onmousemove = function(e) {
                        tooltipDiv.style.top = (e.pageY + 10) + 'px';
                        tooltipDiv.style.left = (e.pageX + 10) + 'px';
                      };
                    },
                    onLeave: function() {
                      const tooltipDiv = document.getElementById('legendTooltip');
                      if (tooltipDiv) {
                        tooltipDiv.remove();
                      }
                      document.onmousemove = null;
                    }
                  },
                  tooltip: {
                    callbacks: {
                      label: function(tooltipItem) {
                        return `${tooltipItem.label}: ${tooltipItem.raw}`;
                      }
                    }
                  }
                },
                layout: {
                  padding: {
                    left: 10,
                    right: 100
                  }
                }
              }
            });
          } else {
            document.getElementById(chartId).style.display = 'none';
            document.getElementById(noDataId).style.display = 'block';
          }
        };
        
        // Ongoing Activities
        const ongoingActivitiesLabels = [{% for activity in ongoing_activities %}'{{ activity.activity_name }}',{% endfor %}];
        const ongoingActivitiesData = [{% for activity in ongoing_activities %}1,{% endfor %}];
        const ongoingActivitiesLinks = [{% for activity in ongoing_activities %}'{% url "activity_detailCM" activity.id %}?semester={{ selected_semester_id }}',{% endfor %}];
        createPieChart('ongoingActivitiesChart', ongoingActivitiesLabels, ongoingActivitiesData, ongoingActivitiesLinks, 'noDataOngoing'); 

        {% comment %} // Ongoing Activities Labels (Grouped by Type)
        const ongoingActivitiesLabels = [
          {% for group in ongoing_activities_grouped %}
            '{{ group.activity_type__name }}: {{ group.count }}',
          {% endfor %}
        ];

        // Individual Data Points for the Chart
        const ongoingActivitiesData = [
          {% for activity in ongoing_activities %}
            1,  // Each activity is counted as 1 to retain original data count
          {% endfor %}
        ];

        // Links for Each Individual Data Point
        const ongoingActivitiesLinks = [
          {% for activity in ongoing_activities_links %}
            '{{ activity.link }}',
          {% endfor %}
        ];

        // Create the chart, keeping labels consolidated for display but linking data points individually
        createPieChart('ongoingActivitiesChart', ongoingActivitiesLabels, ongoingActivitiesData, ongoingActivitiesLinks, 'noDataOngoing'); {% endcomment %}


        // Upcoming Activities
        const upcomingActivitiesLabels = [{% for activity in upcoming_activities %}'{{ activity.activity_name }}',{% endfor %}];
        const upcomingActivitiesData = [{% for activity in upcoming_activities %}1,{% endfor %}];
        const upcomingActivitiesLinks = [{% for activity in upcoming_activities %}'#',{% endfor %}];
        createPieChart('upcomingActivitiesChart', upcomingActivitiesLabels, upcomingActivitiesData, upcomingActivitiesLinks, 'noDataUpcoming');

        // Activities to be Graded
        const gradingNeededLabels = [{% for activity, count in activities_with_grading_needed %}'{{ activity.activity_name }}',{% endfor %}];
        const gradingNeededData = [{% for activity, count in activities_with_grading_needed %}{{ count }},{% endfor %}];
        const gradingNeededLinks = [{% for activity, count in activities_with_grading_needed %}'{% url "grade_essays" activity.id %}?semester={{ selected_semester_id }}',{% endfor %}];
        createPieChart('activitiesToBeGradedChart', gradingNeededLabels, gradingNeededData, gradingNeededLinks, 'noDataGradingNeeded');


        document.addEventListener('DOMContentLoaded', function() {
          const subjectId = {{ subject.id }};
        
            // Fetch the computed styles of the root element (where CSS variables are defined)
      const rootStyles = getComputedStyle(document.documentElement);

      // Get the CSS variable values
      const primaryColor = rootStyles.getPropertyValue('--primary').trim();  // Primary color for completed
      const dangerColor = rootStyles.getPropertyValue('--danger').trim();    // Danger color for missed

      fetch("{% url 'termActivitiesGraph' 0 %}".replace('0', subjectId))
        .then(response => response.json())
        .then(data => {
          const terms = Object.keys(data.terms);  // Get all term names (e.g., ['Prelim', 'Midterm', 'Finals'])
          const termIds = terms.map(term => data.terms[term].id);
          const activityTypeSelect = document.getElementById('activityTypeSelect');

          // Get all activity types and add "All" option
          let activityTypes = [...new Set(terms.flatMap(term => Object.keys(data.terms[term].activity_types || {})))];
          const allOption = document.createElement('option');
          allOption.value = 'All';
          allOption.textContent = 'All Activities';
          activityTypeSelect.appendChild(allOption);

          // Populate dropdown with individual activity types
          activityTypes.forEach(activityType => {
            const option = document.createElement('option');
            option.value = activityType;
            option.textContent = activityType;
            activityTypeSelect.appendChild(option);
          });

          // Initial chart display for "All" activities
          updateChartForActivityType('All');

          // Event listener to update chart when a new activity type is selected
          activityTypeSelect.addEventListener('change', function() {
            const selectedActivityType = this.value;
            updateChartForActivityType(selectedActivityType);
          });

          function updateChartForActivityType(activityType) {
            let datasets = [];
          
            // Fetch the computed styles (CSS variables) from the root element
            const rootStyles = getComputedStyle(document.documentElement);
            const colors = [
              rootStyles.getPropertyValue('--primary').trim(),
              rootStyles.getPropertyValue('--success').trim(),
              rootStyles.getPropertyValue('--info').trim(),
              rootStyles.getPropertyValue('--warning').trim(),
              rootStyles.getPropertyValue('--danger').trim(),
              rootStyles.getPropertyValue('--secondary').trim()
            ];
          
            let colorIndex = 0;
          
            if (activityType === 'All') {
              activityTypes.forEach((type) => {
                const completedData = terms.map(term => data.terms[term].activity_types[type]?.completed || 0);
                const missedData = terms.map(term => -Math.abs(data.terms[term].activity_types[type]?.missed || 0));
          
                // Assign a different color for each activity type
                const completedColor = colors[colorIndex % colors.length];
                const missedColor = colors[(colorIndex + 1) % colors.length];
                colorIndex += 2;
          
                datasets.push({
                  label: `${type} - Completed`,
                  data: completedData,
                  backgroundColor: completedColor,
                  borderColor: completedColor,
                  borderWidth: 2,
                  fill: true,
                  pointBackgroundColor: completedColor,
                  pointRadius: 5,
                  pointHoverRadius: 7
                });
          
                datasets.push({
                  label: `${type} - Missed`,
                  data: missedData,
                  backgroundColor: missedColor,
                  borderColor: missedColor,
                  borderWidth: 2,
                  fill: true,
                  pointBackgroundColor: missedColor,
                  pointRadius: 5,
                  pointHoverRadius: 7
                });
              });
            } else {
              const completedData = terms.map(term => data.terms[term].activity_types[activityType]?.completed || 0);
              const missedData = terms.map(term => -Math.abs(data.terms[term].activity_types[activityType]?.missed || 0));
          
              // Completed dataset with primary color
              datasets.push({
                label: `${activityType} - Completed`,
                data: completedData,
                backgroundColor: colors[0], // Primary color for completed
                borderColor: colors[0],
                borderWidth: 2,
                fill: true,
                pointBackgroundColor: colors[0],
                pointRadius: 5,
                pointHoverRadius: 7
              });
          
              // Missed dataset with danger color
              datasets.push({
                label: `${activityType} - Missed`,
                data: missedData,
                backgroundColor: colors[1], // Danger color for missed
                borderColor: colors[1],
                borderWidth: 2,
                fill: true,
                pointBackgroundColor: colors[1],
                pointRadius: 5,
                pointHoverRadius: 7
              });
            }
          
            createStackedLineChart('finishedActivitiesChart', terms, termIds, datasets);
          }
          

        function createStackedLineChart(chartId, labels, termIds, datasets) {
          const ctx = document.getElementById(chartId).getContext('2d');
          
          if (window.chartInstance) {
            window.chartInstance.destroy();  // Destroy previous chart instance before creating a new one
          }

          window.chartInstance = new Chart(ctx, {
            type: 'line',  // Stacked line chart
            data: {
              labels: labels,  // Term names as labels (Prelim, Midterm, Finals)
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  stacked: true,
                  title: {
                    display: true,
                    text: 'Number of Students'
                  },
                  ticks: {
                    callback: function(value, index, values) {
                      // Ensure Y-axis only shows positive values even for negative data
                      return Math.abs(value);
                    }
                  }
                },
                x: {
                  title: {
                    display: true,
                  }
                }
              },
              plugins: {
                legend: {
                  display: true
                },
                title: {
                  display: true,
                  text: 'Students Completed vs Missed per Term'
                },
                tooltip: {
                  callbacks: {
                    label: function(tooltipItem) {
                      // Ensure tooltips show positive values for missed data
                      return `${tooltipItem.dataset.label}: ${Math.abs(tooltipItem.raw)}`;
                    }
                  }
                }
              },
              onClick: function(evt) {
                const points = window.chartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);

                if (points.length > 0) {
                  const firstPoint = points[0];
                  const index = firstPoint.index;
                  const datasetIndex = firstPoint.datasetIndex;

                  const termId = termIds[index];  // Use the index to fetch the correct term ID
                  const activityType = datasetIndex % 2 === 0 ? 'completed' : 'missed';  // Even index means completed, odd means missed
                  const activityName = datasets[datasetIndex].label.split(' - ')[0];  // Get the activity type name from the dataset label

                  // Redirect to the activities page for the selected term and activity type
                  if (termId) {
                    window.location.href = `/displayActivitiesForTermCM/${termId}/${activityType}/${subjectId}/${activityName}/`;
                  } else {
                    console.error('Term ID is undefined for index:', index);
                  }
                }
              }
            }
          });
        }

      })
      .catch(error => console.error('Error fetching term activities:', error));

        });
    </script>

    <script>
      let lessonEditMode = false;
      let sortable = null;

      document.getElementById('editButton').addEventListener('click', function () {
        if (!lessonEditMode) {
          // Enable lesson editing mode
          lessonEditMode = true;
          this.textContent = 'Save'; // Change button text to "Save"

          // Initialize SortableJS for the lesson list
          sortable = new Sortable(document.getElementById('lesson-list'), {
            animation: 150,
            onEnd: function (evt) {
              var order = [];
              document.querySelectorAll('#lesson-list li').forEach(function (item) {
                order.push(item.getAttribute('data-id'));
              });
            }
          });
        } else {
          // Disable lesson editing mode
          lessonEditMode = false;
          this.textContent = 'Edit'; // Change button text back to "Edit"

          // Disable sorting by destroying the SortableJS instance
          if (sortable) {
            sortable.destroy();
          }

          // Collect the new order and send it to the server via AJAX
          var order = [];
          document.querySelectorAll('#lesson-list li').forEach(function (item) {
            var moduleId = item.getAttribute('data-id');
            if (moduleId) {  // Ensure only valid module IDs are added
              order.push(moduleId);
            }
          });

          // Send the updated order to the backend
          fetch("{% url 'update_module_order' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ order: order })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              // Successfully saved the new order
            } else {
              console.error('Error saving order:', data.message);
            }
          })
          .catch(error => {
            console.error('An error occurred while saving the order:', error);
          });
        }
      });
    </script>

    <script>
      $(document).ready(function () {
          // Event delegation to handle dynamically loaded content inside the modal
          $(document).on('click', '.selectAll', function () {
              const statusId = $(this).data('status'); // Get the status ID from data attribute

              // Find and check all radio buttons with the class for this status
              $(`.status-${statusId}`).prop('checked', true);
          });
      });
    </script>

    <script>
      function displayToast(message, icon) {
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: icon,
          title: message,
          showConfirmButton: false,
          timer: 5000,
          timerProgressBar: true,
        });
      }
  
      // Check for form errors and display them with error icon
      {% if form.errors %}
        {% for field in form %}
          {% for error in field.errors %}
            displayToast("{{ error }}", 'error');  // Display form errors with 'error' icon
          {% endfor %}
        {% endfor %}
      {% endif %}
  
      // Check for Django messages and handle their type
      {% if messages %}
        {% for message in messages %}
          {% if message.tags == 'error' %}
            displayToast("{{ message }}", 'error');  // Display error messages
          {% else %}
            displayToast("{{ message }}", 'success');  // Display success or other messages
          {% endif %}
        {% endfor %}
      {% endif %}
    </script>
    <script>
      // Disable past dates in the date input field
      document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('attendanceDate');
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today); // Set the minimum selectable date to today
      });
    </script>

  {% if is_teacher %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          const days = [
              "sunday", "monday", "tuesday", "wednesday",
              "thursday", "friday", "saturday"
          ];
      
          // Initialize SortableJS for each day's column
          days.forEach((day) => {
              const column = document.querySelector(`.lesson-column:nth-child(${days.indexOf(day) + 1})`);
              if (column) {
                  new Sortable(column, {
                      animation: 150,
                      ghostClass: "sortable-ghost",
                      onEnd: function (evt) {
                          console.log(`Moved lesson from index ${evt.oldIndex} to ${evt.newIndex}`);
                      }
                  });
              }
          });
      
          // Add click event for lesson cards to redirect to viewModuleCM
          document.querySelectorAll(".lesson-card").forEach((card) => {
              card.addEventListener("click", function () {
                  const moduleId = this.dataset.moduleId; // Get module ID from dataset
                  if (moduleId) {
                      window.location.href = `/viewModuleCM/${moduleId}/`; // Redirect to viewModuleCM
                  }
              });
          });
      
          // Set weekly dates dynamically
          const today = new Date();
          const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
      
          days.forEach((day, index) => {
              let currentDate = new Date(firstDayOfWeek);
              currentDate.setDate(firstDayOfWeek.getDate() + index);
              let formattedDate = currentDate.toLocaleDateString("en-US", { month: "short", day: "numeric" });
      
              document.getElementById(`${day}-date`).innerText = `(${formattedDate})`;
          });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          const today = new Date();
          const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay())); // Start from Sunday
      
          const days = [
              "sunday", "monday", "tuesday", "wednesday",
              "thursday", "friday", "saturday"
          ];
      
          days.forEach((day, index) => {
              let currentDate = new Date(firstDayOfWeek);
              currentDate.setDate(firstDayOfWeek.getDate() + index); // Get the date for each day
              let formattedDate = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      
              document.getElementById(`${day}-date`).innerText = `(${formattedDate})`;
          });
      });
    </script>
  {% endif %}
  </body>
</html>
