{% extends 'base.html' %}
{% load static %}
{% block title %}
  {{ subject.subject_name }}
{% endblock %}
{% block content %}
 
  <!-- Content Header (Page header) -->
  <div class="row mb-2">
    <div class="col-sm-6">
      <h3 class="m-0">{{ subject.subject_name }}</h3>
    </div>
    {% if is_teacher %}
      <div class="col-sm-6">
        <ol class="breadcrumb float-end">
          <a href="{% url 'enter_classroom_mode_view' subject.id %}" class="btn btn-primary"><i class="fas fa-chalkboard-teacher"></i> Smart Classroom Mode</a> &nbsp;
          <a href="javascript:void(0);" class="btn btn-success" id="classActionButton" data-subject-id="{{ subject.id }}" data-is-active="false"><i class="fas fa-chalkboard-teacher"></i> Start Class</a>
        </ol>
      </div>
    {% endif %}
  </div>
 
  <div class="row justify-content-center mb-2">
    <div class="col-md-12">
      <p class="text-muted">Explore activities, lessons, and more for {{ subject.subject_name }}.</p>
    </div>
    <div></div>
  </div>
 
        <!-- Row of Pie Charts inside Cards -->
  <div class="row mb-2">
          <!-- Ongoing Activities Chart -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold bg-success text-center">Ongoing Activities</div>
        <div class="card-body" style="height: 200px;">
          <canvas id="ongoingActivitiesChart" class="activity-chart"></canvas>
          <p id="noDataOngoing" class="text-center text-muted" style="display: none;">No ongoing activities</p>
        </div>
      </div>
    </div>
 
          <!-- Upcoming Activities Chart -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold bg-success text-center">Upcoming Activities</div>
        <div class="card-body" style="height: 200px;">
          <canvas id="upcomingActivitiesChart" class="activity-chart"></canvas>
          <p id="noDataUpcoming" class="text-center text-muted" style="display: none;">No upcoming activities</p>
        </div>
      </div>
    </div>
 
          <!-- Activities to be Graded Chart -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold bg-success text-center">Activities to be Graded</div>
        <div class="card-body" style="height: 200px;">
          <canvas id="activitiesToBeGradedChart" class="activity-chart"></canvas>
          <p id="noDataGradingNeeded" class="text-center text-muted" style="display: none;">No activities to be graded</p>
        </div>
      </div>
    </div>
  </div>
 
        <!-- Completed Activities Chart -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="form-group">
        <label for="activityTypeSelect">Select Activity Type:</label>
        <select id="activityTypeSelect" class="form-control mb-2">
                <!-- Options will be populated dynamically -->
        </select>
      </div>
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold bg-success text-center">Completed Activity Summary</div>
        <div class="card-body" style="height: 300px;">
          <canvas id="finishedActivitiesChart" class="activity-chart"></canvas>
          <p id="noDataFinished" class="text-center text-muted" style="display: none;">No completed activities</p>
        </div>
      </div>
    </div>
  </div>
 
        <!-- Teacher's section -->
  {% if is_teacher %}


  <div class="d-flex justify-content-center mb-4">
    {% if subject.is_coil and not is_collaborator %}
      <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#inviteCollaboratorModal">
        <i class="fas fa-user-plus"></i> Invite Collaborator
      </button>
   
    <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#inviteStudentModal">
      <i class="fas fa-user-graduate"></i> Invite Student
    </button>
       {% endif %}
  </div>


    {% now 'Y-m-d' as today_date %}
    {% if selected_semester.start_date|date:'Y-m-d' <= today_date and selected_semester.end_date|date:'Y-m-d' >= today_date %}
      <div class="row justify-content-center mb-4">
        <div class="col-md-12">
          <div class="d-flex flex-wrap justify-content-center">
            <a class="btn btn-success mb-2 mx-2" data-bs-toggle="modal" data-bs-target="#addActivityLessonModalStandard">
              <i class="fas fa-plus"></i> Add an Activity or Lesson
            </a>
            <a href="{% url 'activityList' subject.id %}" class="btn btn-primary mb-2 mx-2">Activity List</a>
            <a class="btn btn-info mb-2 mx-2" onclick="openCopyActivityModal('{{ subject.id }}')">Copy Activities</a>
            <button class="btn btn-info mb-2 mx-2" onclick="openCopyLessonModal('{{ subject.id }}')">Copy Lessons</button>
            <a href="{% url 'subjectStudentList' subject.id %}?semester={{ selected_semester_id }}" class="btn btn-warning mb-2 mx-2">View Students List</a>
            <a href="{% url 'attendanceList' subject.id %}" class="btn btn-primary mb-2 mx-2">Attendance List</a>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}
 
  <div class="row mb-4">
    <div class="col-md-12 mx-auto">
      <div class="card shadow-sm">
        <div class="card-header bg-success d-flex justify-content-between align-items-center">
          <span class="text-white fw-bold">Lessons &nbsp;<sup>(Organized by Week)</sup></span>
                      <!-- Month Selector Dropdown -->
          <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" id="monthSelector"
                    data-bs-toggle="dropdown" aria-expanded="false">
              Select Month
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="monthSelector" id="monthDropdown">
          <!-- Dynamic month options will be inserted here -->
            </ul>
          </div>
        </div>
        <!-- Bootstrap 5 Accordion -->
        <div class="accordion" id="lessonAccordion">
          <div id="lesson-list">
          <!-- Dynamic lesson content will be inserted here -->
          </div>
        </div>
      </div>
    </div>
  </div>
 
  <!-- Bootstrap Modal for Adding Activity or Lesson -->
  <div class="modal fade" id="addActivityLessonModalStandard" tabindex="-1" aria-labelledby="addActivityLessonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addActivityLessonModalLabel">Add an Activity or Lesson</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row g-3">
                        <!-- Assignment -->
              <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 py-3 d-flex flex-column align-items-center"
                        onclick="selectActivityTypeAndRedirect('Assignment', {{ subject.id }}, {{ assignment_activity_type_id }}, false)">
                  <i class="fas fa-check-square fa-2x mb-2"></i> Assignment
                </button>
              </div>
                        <!-- Attendance -->
              <div class="col-md-4">
                <button class="btn btn-outline-success w-100 py-3 d-flex flex-column align-items-center"
                        onclick="openAttendanceModal('{{ subject.id }}')">
                  <i class="fas fa-user-check fa-2x mb-2"></i> Attendance
                </button>
              </div>
                        <!-- Participation -->
              <div class="col-md-4">
                <button class="btn btn-outline-danger w-100 py-3 d-flex flex-column align-items-center"
                        onclick="selectActivityTypeAndRedirect('Participation', {{ subject.id }}, {{ participation_activity_type_id }})">
                  <i class="fas fa-users fa-2x mb-2"></i> Participation
                </button>
              </div>
                        <!-- Lesson -->
              <div class="col-md-4">
                <button class="btn btn-outline-warning w-100 py-3 d-flex flex-column align-items-center"
                        onclick="openModuleModalStandard({{ subject.id }}, 'lesson')">
                  <i class="fas fa-book fa-2x mb-2"></i> Lesson
                </button>
              </div>
                        <!-- Video Conference -->
              <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 py-3 d-flex flex-column align-items-center"
                        data-bs-toggle="modal" data-bs-target="#teamsSignInModal">
                  <i class="fas fa-video fa-2x mb-2"></i> Ms Teams
                </button>
              </div> 
                        <!-- Video Conference -->
              <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 py-3 d-flex flex-column align-items-center"
                        data-bs-toggle="modal" data-bs-target="#zoomSignInModal">
                  <i class="fas fa-video fa-2x mb-2"></i>  Zoom
                </button>
              </div>

                          <!-- Video Conference -->
              <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 py-3 d-flex flex-column align-items-center"
                        data-bs-toggle="modal" data-bs-target="#googleMeetSignInModal">
                  <i class="fas fa-video fa-2x mb-2"></i> Google Meet
                </button>
              </div>

                        <!-- Quiz -->
              <div class="col-md-4">
                <button class="btn btn-outline-danger w-100 py-3 d-flex flex-column align-items-center"
                        onclick="selectActivityTypeAndRedirect('Quiz', {{ subject.id }}, {{ quiz_activity_type_id }})">
                  <i class="fas fa-question-circle fa-2x mb-2"></i> Quiz
                </button>
              </div>
                        <!-- Exam -->
              <div class="col-md-4">
                <button class="btn btn-outline-info w-100 py-3 d-flex flex-column align-items-center"
                        onclick="selectActivityTypeAndRedirect('Exam', {{ subject.id }}, {{ exam_activity_type_id }})">
                  <i class="fas fa-file-alt fa-2x mb-2"></i> Exam
                </button>
              </div>
                        <!-- Special Activity -->
              <div class="col-md-4">
                <button class="btn btn-outline-secondary w-100 py-3 d-flex flex-column align-items-center"
                        onclick="selectActivityTypeAndRedirect('Special', {{ subject.id }}, {{ special_activity_type_id }})">
                  <i class="fas fa-star fa-2x mb-2"></i> Special Activity
                </button>
              </div>
                        <!-- URL -->
              <div class="col-md-4">
                <button class="btn btn-outline-secondary w-100 py-3 d-flex flex-column align-items-center"
                        onclick="openModuleModalStandard({{ subject.id }}, 'url')">
                  <i class="fas fa-link fa-2x mb-2"></i> URL
                </button>
              </div>
                        <!-- Embed Code -->
              <div class="col-md-4">
                <button class="btn btn-outline-success w-100 py-3 d-flex flex-column align-items-center"
                        onclick="openModuleModalStandard({{ subject.id }}, 'embed')">
                  <img src="/static/assets/img/embed.png" alt="Embed Icon" style="width: 50px; height: 50px;">
                  Embed Code
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
 
  <!-- Custom Modal for Adding Participation -->
  <div id="participationModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between">
      <h5>Select Participation Details</h5>
      <button class="close-btn" id="closeParticipationModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="participationModalBody"></div>
  </div>
  <div id="participationModalBackdrop" class="custom-modal-backdrop"></div>
 
  <!-- Custom Modal for Adding Module -->
  <div id="moduleModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between">
      <h5 class="text-dark">Add Lesson</h5>
 
      <button class="close-btn" id="closeModuleModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="moduleModalBody"></div>
  </div>
  <div id="moduleModalBackdrop" class="custom-modal-backdrop"></div>
 
  <!-- Copy Lessons Modal -->
  <div id="copyLessonModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between">
      <h5 class="text-dark">Copy Lessons</h5>
      <button class="close-btn" id="closeCopyLessonModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="copyLessonModalBody"></div>
  </div>
  <div id="copyLessonModalBackdrop" class="custom-modal-backdrop"></div>
 
  <!-- Custom Modal for Copying Activities -->
  <div id="copyActivityModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between">
      <h5 class="text-dark">Copy Activities</h5>
      <button class="close-btn" id="closeCopyActivityModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="copyActivityModalBody"></div>
  </div>
  <div id="copyActivityModalBackdrop" class="custom-modal-backdrop"></div>
 
  <!-- Modal for Microsoft Teams Sign-in -->
  <div class="modal" id="teamsSignInModal" tabindex="-1" role="dialog" aria-labelledby="teamsSignInModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content card-style-modal">
        <div class="modal-header">
          <h5 class="modal-title" id="teamsSignInModalLabel">Sign in to Microsoft Teams</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <p>To start your Microsoft Teams meeting, sign in using your school account.</p>
          <a href="https://teams.microsoft.com" target="_blank" class="btn btn-primary">Sign in to Microsoft Teams</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Zoom Sign-in -->
<div class="modal" id="zoomSignInModal" tabindex="-1" role="dialog" aria-labelledby="zoomSignInModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content card-style-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="zoomSignInModalLabel">Sign in to Zoom</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>To start your Zoom meeting, sign in using your school or Zoom account.</p>
        <a href="https://zoom.us/signin" target="_blank" class="btn btn-primary">Sign in to Zoom</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Google Meet Sign-in -->
<div class="modal" id="googleMeetSignInModal" tabindex="-1" role="dialog" aria-labelledby="googleMeetSignInModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content card-style-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="googleMeetSignInModalLabel">Sign in to Google Meet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>To start your Google Meet session, sign in using your Google account.</p>
        <a href="https://meet.google.com" target="_blank" class="btn btn-primary">Sign in to Google Meet</a>
      </div>
    </div>
  </div>
</div>

 
  <!-- Attendance Modal -->
  <div id="attendanceModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between">
      <h5 class="text-dark">Record Attendance</h5>
      <button class="close-btn" id="closeAttendanceModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="attendanceModalBody"></div>
  </div>
  <div id="attendanceModalBackdrop" class="custom-modal-backdrop"></div>
 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Invite Collaborator Modal -->
<div class="modal fade" id="inviteCollaboratorModal" tabindex="-1" aria-labelledby="inviteCollaboratorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{% url 'send_collaboration_invite' subject.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="inviteCollaboratorModalLabel"><i class="fas fa-user-plus me-2"></i>Invite a Collaborator</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Enter the email address of the teacher you want to invite to collaborate on this subject.</p>
          <input type="email" name="email" class="form-control" placeholder="teacher@example.com" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Send Invite</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Invite Student -->
<div class="modal fade" id="inviteStudentModal" tabindex="-1" aria-labelledby="inviteStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{% url 'send_student_invite' subject.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="inviteStudentModalLabel">Invite Student to Subject</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="studentEmail" class="form-label">Student Email</label>
            <input type="email" name="email" class="form-control" id="studentEmail" placeholder="student@example.com" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Send Invite</button>
        </div>
      </div>
    </form>
  </div>
</div>


 
  <script>
    function confirmDeleteLesson(moduleId) {
      Swal.fire({
          title: 'Are you sure?',
          text: 'This lesson will be deleted and cannot be recovered!',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, delete it!',
          cancelButtonText: 'Cancel'
      }).then((result) => {
          if (result.isConfirmed) {
              // âœ… Check if deletion is possible before redirecting
              fetch(`/checkModuleDependency/${moduleId}/`)
                  .then(response => response.json())
                  .then(data => {
                      if (data.can_delete) {
                          window.location.href = `/deleteModule/${moduleId}/`;
                      } else {
                          Swal.fire({
                              title: 'Deletion Not Allowed!',
                              text: 'This module cannot be deleted because it is referenced by other records. Please remove the linked activities first.',
                              icon: 'error'
                          });
                      }
                  })
                  .catch(error => {
                      console.error('Error checking module dependency:', error);
                      Swal.fire({
                          title: 'Error!',
                          text: 'Something went wrong while checking module dependencies.',
                          icon: 'error'
                      });
                  });
          }
      });
  }  
  </script>
 
  <script>
    const createPieChart = (chartId, labels, data, links, noDataId) => {
      const ctx = document.getElementById(chartId).getContext('2d');
 
      // Define Soft Pastel Colors
      const pastelColors = [
        "#FFB3BA", // Soft Red
        "#FFDFBA", // Soft Orange
        "#FFFFBA", // Soft Yellow
        "#BAFFC9", // Soft Green
        "#BAE1FF", // Soft Blue
        "#E6C9F9", // Soft Purple
        "#FFC6FF", // Soft Pink
        "#D4A5A5", // Muted Peach
        "#B5EAD7", // Pastel Teal
        "#C7CEEA"  // Light Lavender
      ];
 
      if (data.length > 0) {
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels.map(label => label.length > 20 ? label.substring(0, 20) + '...' : label), // Truncate long labels
            datasets: [{
              data: data,
              backgroundColor: pastelColors.slice(0, data.length), // Apply pastel colors
              borderColor: "rgba(255,255,255,0.8)", // White border for clarity
              borderWidth: 2
            }],
          },
          options: {
            onClick: (event, array) => {
              if (array.length) {
                const index = array[0].index;
                window.location.href = links[index];
              }
            },
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'left',
                align: 'start',
                labels: {
                  usePointStyle: true,
                  padding: 15,
                  font: {
                    size: 12,
                    family: "Arial, sans-serif",
                    weight: "bold",
                    color: "#444" // Darker text for better contrast
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(tooltipItem) {
                    return `${tooltipItem.label}: ${tooltipItem.raw}`;
                  }
                }
              }
            },
            layout: {
              padding: { left: 10, right: 100 }
            }
          }
        });
      } else {
        document.getElementById(chartId).style.display = 'none';
        document.getElementById(noDataId).style.display = 'block';
      }
    };
 
 
    // Ongoing Activities
    const ongoingActivitiesLabels = [{% for activity in ongoing_activities %}'{{ activity.activity_name }}',{% endfor %}];
    const ongoingActivitiesData = [{% for activity in ongoing_activities %}1,{% endfor %}];
    const ongoingActivitiesLinks = [{% for activity in ongoing_activities %}'{% url "activity_detail" activity.id %}?semester={{ selected_semester_id }}',{% endfor %}];
    createPieChart('ongoingActivitiesChart', ongoingActivitiesLabels, ongoingActivitiesData, ongoingActivitiesLinks, 'noDataOngoing');
 
    // Upcoming Activities
    const upcomingActivitiesLabels = [{% for activity in upcoming_activities %}'{{ activity.activity_name }}',{% endfor %}];
    const upcomingActivitiesData = [{% for activity in upcoming_activities %}1,{% endfor %}];
    const upcomingActivitiesLinks = [{% for activity in upcoming_activities %}'#',{% endfor %}];
    createPieChart('upcomingActivitiesChart', upcomingActivitiesLabels, upcomingActivitiesData, upcomingActivitiesLinks, 'noDataUpcoming');
 
    // Activities to be Graded
    const gradingNeededLabels = [{% for activity, count in activities_with_grading_needed %}'{{ activity.activity_name }}',{% endfor %}];
    const gradingNeededData = [{% for activity, count in activities_with_grading_needed %}{{ count }},{% endfor %}];
    const gradingNeededLinks = [{% for activity, count in activities_with_grading_needed %}'{% url "grade_essays" activity.id %}?semester={{ selected_semester_id }}',{% endfor %}];
    createPieChart('activitiesToBeGradedChart', gradingNeededLabels, gradingNeededData, gradingNeededLinks, 'noDataGradingNeeded');
 
 
    document.addEventListener('DOMContentLoaded', function() {
      const subjectId = {{ subject.id }};
 
        // Fetch the computed styles of the root element (where CSS variables are defined)
      const rootStyles = getComputedStyle(document.documentElement);
 
  // Get the CSS variable values
      const primaryColor = rootStyles.getPropertyValue('--primary').trim();  // Primary color for completed
      const dangerColor = rootStyles.getPropertyValue('--danger').trim();    // Danger color for missed
 
      fetch("{% url 'termActivitiesGraph' 0 %}".replace('0', subjectId))
        .then(response => response.json())
        .then(data => {
          const terms = Object.keys(data.terms);  // Get all term names (e.g., ['Prelim', 'Midterm', 'Finals'])
          const termIds = terms.map(term => data.terms[term].id);
          const activityTypeSelect = document.getElementById('activityTypeSelect');
 
      // Get all activity types and add "All" option
          let activityTypes = [...new Set(terms.flatMap(term => Object.keys(data.terms[term].activity_types || {})))];
          const allOption = document.createElement('option');
          allOption.value = 'All';
          allOption.textContent = 'All Activities';
          activityTypeSelect.appendChild(allOption);
 
      // Populate dropdown with individual activity types
          activityTypes.forEach(activityType => {
            const option = document.createElement('option');
            option.value = activityType;
            option.textContent = activityType;
            activityTypeSelect.appendChild(option);
          });
 
      // Initial chart display for "All" activities
          updateChartForActivityType('All');
 
      // Event listener to update chart when a new activity type is selected
          activityTypeSelect.addEventListener('change', function() {
            const selectedActivityType = this.value;
            updateChartForActivityType(selectedActivityType);
          });
 
          function updateChartForActivityType(activityType) {
            let datasets = [];
 
        // Fetch the computed styles (CSS variables) from the root element
            const colors = [
            "#FFB3BA", // Soft Red
            "#FFDFBA", // Soft Orange
            "#FFFFBA", // Soft Yellow
            "#BAFFC9", // Soft Green
            "#BAE1FF", // Soft Blue
            "#E6C9F9", // Soft Purple
            "#FFC6FF", // Soft Pink
            "#D4A5A5", // Muted Peach
            "#B5EAD7", // Pastel Teal
            "#C7CEEA"  // Light Lavender
          ];
 
 
            let colorIndex = 0;
 
            if (activityType === 'All') {
              activityTypes.forEach((type) => {
                const completedData = terms.map(term => data.terms[term].activity_types[type]?.completed || 0);
                const missedData = terms.map(term => -Math.abs(data.terms[term].activity_types[type]?.missed || 0));
 
            // Assign a different color for each activity type
                const completedColor = colors[colorIndex % colors.length];
                const missedColor = colors[(colorIndex + 1) % colors.length];
                colorIndex += 2;
 
                datasets.push({
                  label: `${type} - Completed`,
                  data: completedData,
                  backgroundColor: completedColor,
                  borderColor: completedColor,
                  borderWidth: 2,
                  fill: true,
                  pointBackgroundColor: completedColor,
                  pointRadius: 5,
                  pointHoverRadius: 7
                });
 
                datasets.push({
                  label: `${type} - Missed`,
                  data: missedData,
                  backgroundColor: missedColor,
                  borderColor: missedColor,
                  borderWidth: 2,
                  fill: true,
                  pointBackgroundColor: missedColor,
                  pointRadius: 5,
                  pointHoverRadius: 7
                });
              });
            } else {
              const completedData = terms.map(term => data.terms[term].activity_types[activityType]?.completed || 0);
              const missedData = terms.map(term => -Math.abs(data.terms[term].activity_types[activityType]?.missed || 0));
 
          // Completed dataset with primary color
              datasets.push({
                label: `${activityType} - Completed`,
                data: completedData,
                backgroundColor: colors[0], // Primary color for completed
                borderColor: colors[0],
                borderWidth: 2,
                fill: true,
                pointBackgroundColor: colors[0],
                pointRadius: 5,
                pointHoverRadius: 7
              });
 
          // Missed dataset with danger color
              datasets.push({
                label: `${activityType} - Missed`,
                data: missedData,
                backgroundColor: colors[1], // Danger color for missed
                borderColor: colors[1],
                borderWidth: 2,
                fill: true,
                pointBackgroundColor: colors[1],
                pointRadius: 5,
                pointHoverRadius: 7
              });
            }
 
            createStackedLineChart('finishedActivitiesChart', terms, termIds, datasets);
          }
 
 
          function createStackedLineChart(chartId, labels, termIds, datasets) {
            const ctx = document.getElementById(chartId).getContext('2d');
 
            if (window.chartInstance) {
              window.chartInstance.destroy();  // Destroy previous chart instance before creating a new one
            }
 
            window.chartInstance = new Chart(ctx, {
              type: 'line',  // Stacked line chart
              data: {
                labels: labels,  // Term names as labels (Prelim, Midterm, Finals)
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    stacked: true,
                    title: {
                      display: true,
                      text: 'Number of Students'
                    },
                    ticks: {
                      callback: function(value, index, values) {
                  // Ensure Y-axis only shows positive values even for negative data
                        return Math.abs(value);
                      }
                    }
                  },
                  x: {
                    title: {
                      display: true,
                    }
                  }
                },
                plugins: {
                  legend: {
                    display: true
                  },
                  title: {
                    display: true,
                    text: 'Students Completed vs Missed per Term'
                  },
                  tooltip: {
                    callbacks: {
                      label: function(tooltipItem) {
                  // Ensure tooltips show positive values for missed data
                        return `${tooltipItem.dataset.label}: ${Math.abs(tooltipItem.raw)}`;
                      }
                    }
                  }
                },
                onClick: function(evt) {
                  const points = window.chartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
 
                  if (points.length > 0) {
                    const firstPoint = points[0];
                    const index = firstPoint.index;
                    const datasetIndex = firstPoint.datasetIndex;
 
                    const termId = termIds[index];  // Use the index to fetch the correct term ID
                    const activityType = datasetIndex % 2 === 0 ? 'completed' : 'missed';  // Even index means completed, odd means missed
                    const activityName = datasets[datasetIndex].label.split(' - ')[0];  // Get the activity type name from the dataset label
 
              // Redirect to the activities page for the selected term and activity type
                    if (termId) {
                      window.location.href = `/displayActivitiesForTerm/${termId}/${activityType}/${subjectId}/${activityName}/`;
                    } else {
                      console.error('Term ID is undefined for index:', index);
                    }
                  }
                }
              }
            });
          }
 
        })
        .catch(error => console.error('Error fetching term activities:', error));
 
    });
 
  </script>
 
  <!-- SortableJS for drag-and-drop functionality (Frontend Only) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
 
  <script>
    // Remove the function that displays the Add Lesson button
    let lessonEditMode = false;
    let sortable = null;
 
    document.getElementById('editButton').addEventListener('click', function () {
      if (!lessonEditMode) {
        // Enable lesson editing mode
        lessonEditMode = true;
        this.textContent = 'Save'; // Change button text to "Save"
 
        // Initialize SortableJS for the lesson list
        sortable = new Sortable(document.getElementById('lesson-list'), {
          animation: 150,
          onEnd: function (evt) {
            var order = [];
            document.querySelectorAll('#lesson-list li').forEach(function (item) {
              order.push(item.getAttribute('data-id'));
            });
          }
        });
      } else {
        // Disable lesson editing mode
        lessonEditMode = false;
        this.textContent = 'Edit'; // Change button text back to "Edit"
 
        // Disable sorting by destroying the SortableJS instance
        if (sortable) {
          sortable.destroy();
        }
 
        // Collect the new order and send it to the server via AJAX
        var order = [];
        document.querySelectorAll('#lesson-list li').forEach(function (item) {
          var moduleId = item.getAttribute('data-id');
          if (moduleId) {  // Ensure only valid module IDs are added
            order.push(moduleId);
          }
        });
 
        // Send the updated order to the backend
        fetch("{% url 'update_module_order' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ order: order })
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
            // Successfully saved the new order
            } else {
              console.error('Error saving order:', data.message);
            }
          })
          .catch(error => {
            console.error('An error occurred while saving the order:', error);
          });
      }
    });
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script>
    $(document).ready(function () {
        // Event delegation to handle dynamically loaded content inside the modal
      $(document).on('click', '.selectAll', function () {
        const statusId = $(this).data('status'); // Get the status ID from data attribute
 
            // Find and check all radio buttons with the class for this status
        $(`.status-${statusId}`).prop('checked', true);
      });
    });
  </script>
  {% if is_teacher %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modules = document.querySelectorAll('.lesson-item');
 
        modules.forEach(module => {
          const activityList = module.querySelector(`#activity-list-${module.dataset.id}`);
 
          if (activityList) {
            new Sortable(activityList, {
              animation: 150,
              onEnd: function (evt) {
                      // Collect new order
                const orderedItems = Array.from(activityList.children).map((item, index) => ({
                  id: item.dataset.id,
                  order: index + 1
                }));
 
                      // Send new order to the server
                fetch("{% url 'update_activity_order' %}", {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                  },
                  body: JSON.stringify({ order: orderedItems })
                })
                  .then(response => response.json())
                  .then(data => {
                    if (data.status === 'success') {
                      console.log('Activity order updated successfully!');
                    } else {
                      alert('Failed to update activity order.');
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                  });
              }
            });
          }
        });
      });
  {% endif %}
  </script>
 
  <script>
    document.addEventListener("DOMContentLoaded", function () {
 
      const isTeacher = {{ is_teacher|yesno:"true,false" }};
 
      // Access the semester_months passed from the view directly
      const semesterMonths = {{ semester_months|safe }};
 
      const monthDropdown = document.getElementById("monthDropdown");
      const monthSelectorButton = document.getElementById("monthSelector");
 
      if (monthDropdown) {
          // Create a dropdown option for each month in the semester
        semesterMonths.forEach(month => {
          const monthOption = document.createElement("a");
          monthOption.classList.add("dropdown-item", "month-option");
          monthOption.setAttribute("data-month", month);
          monthOption.textContent = month;
          monthDropdown.appendChild(monthOption);
        });
 
          // Set the current month as the default option
        const currentMonth = new Date().toLocaleString('default', { month: 'long' });
        const currentMonthOption = document.querySelector(`.month-option[data-month="${currentMonth}"]`);
 
        if (currentMonthOption) {
          currentMonthOption.classList.add('active');
          monthSelectorButton.textContent = `Select Month: ${currentMonth}`;
          fetchScheduleData(currentMonth);  // Fetch data for the current month
        }
 
          // Event listener for month selection
        document.querySelectorAll('.month-option').forEach(option => {
          option.addEventListener('click', function () {
            const selectedMonth = this.getAttribute('data-month');
                  // Fetch data based on the selected month
            monthSelectorButton.textContent = `Month: ${selectedMonth}`;
            fetchScheduleData(selectedMonth);
          });
        });
      }
 
 
// Function to fetch schedule data based on selected month
      function fetchScheduleData(selectedMonth) {
        const subjectId = "{{ subject.id }}"; // Ensure this correctly renders an ID
        const apiUrl = `/api/schedules/${subjectId}/?month=${selectedMonth}&t=${new Date().getTime()}`; // Cache busting
        const lessonList = document.getElementById("lesson-list");
 
        fetch(apiUrl)
          .then(response => response.json())
          .then(scheduleData => {
            console.log("Fetched Schedule Data:", scheduleData); // Debugging
 
            lessonList.innerHTML = ''; // Clear current lessons
            if (!scheduleData.schedule_data || scheduleData.schedule_data.length === 0) {
              lessonList.innerHTML = '<p class="text-center mt-3 text-muted">No schedule available for this subject in the selected month.</p>';
              return;
            }
 
 
          // Render lessons organized by weeks
            const filteredWeeks = scheduleData.schedule_data.filter(week => week.month === selectedMonth);
              filteredWeeks.forEach((week, index) => {
              if (week.dates.length === 0) return;
              const weekId = `week${index + 1}Lessons`;
 
              // Week Container
              const weekItem = document.createElement("div");
              weekItem.classList.add("accordion-item");
 
              // Week Header
              const weekHeader = document.createElement("h2");
              weekHeader.classList.add("accordion-header");
              weekHeader.id = `heading${index}`;
 
              const weekButton = document.createElement("button");
              weekButton.classList.add("accordion-button", "collapsed", "d-flex", "justify-content-between");
              weekButton.setAttribute("type", "button");
              weekButton.setAttribute("data-bs-toggle", "collapse");
              weekButton.setAttribute("data-bs-target", `#${weekId}`);
              weekButton.setAttribute("aria-expanded", "false");
              weekButton.setAttribute("aria-controls", weekId);
              weekButton.innerHTML = `
                  <i class="fas fa-calendar-week text-primary me-2"></i> ${week.week}
              `;
 
              // Week Content
              const weekContent = document.createElement("div");
              weekContent.id = weekId;
              weekContent.classList.add("accordion-collapse", "collapse");
              weekContent.setAttribute("aria-labelledby", `heading${index}`);
              weekContent.setAttribute("data-bs-parent", "#lessonAccordion");
 
              const weekBody = document.createElement("div");
              weekBody.classList.add("accordion-body");
 
              // Days List
              const weekList = document.createElement("div");
              weekList.classList.add("accordion", "mt-2");
 
              week.dates.forEach((dateInfo, dayIndex) => {
                const dayId = `day${index + 1}_${dayIndex + 1}Lessons`;
 
                  // Day Item
                const dayItem = document.createElement("div");
                dayItem.classList.add("accordion-item");
 
                  // Day Header
                const dayHeader = document.createElement("h2");
                dayHeader.classList.add("accordion-header");
                dayHeader.id = `headingDay${index}_${dayIndex}`;
 
                const dayButton = document.createElement("button");
                dayButton.classList.add("accordion-button", "collapsed", "d-flex", "justify-content-between");
                dayButton.setAttribute("type", "button");
                dayButton.setAttribute("data-bs-toggle", "collapse");
                dayButton.setAttribute("data-bs-target", `#${dayId}`);
                dayButton.setAttribute("aria-expanded", "false");
                dayButton.setAttribute("aria-controls", dayId);
                dayButton.innerHTML = `
                      <i class="fas fa-calendar-day text-dark me-2"></i> ${dateInfo.date} - ${formatTime(dateInfo.time)}
                  `;
 
                  // Day Content
                const dayContent = document.createElement("div");
                dayContent.id = dayId;
                dayContent.classList.add("accordion-collapse", "collapse");
                dayContent.setAttribute("aria-labelledby", `headingDay${index}_${dayIndex}`);
                dayContent.setAttribute("data-bs-parent", `#${weekId}`);
 
                const dayBody = document.createElement("div");
                dayBody.classList.add("accordion-body");
 
                  // Lesson List
                const lessonList = document.createElement("ul");
                lessonList.classList.add("list-group", "mt-2");
 
                dateInfo.lessons.forEach((lesson, lessonIndex) => {
                  const lessonId = `lesson${index + 1}_${dayIndex + 1}_${lessonIndex + 1}`;
 
                  let iconClass = "far fa-file-alt text-secondary"; // Default icon
                  if (lesson.type) {
                    switch (lesson.type.toLowerCase()) {
                      case "pdf": iconClass = "far fa-file-pdf text-danger"; break;
                      case "image": iconClass = "far fa-file-image text-success"; break;
                      case "video": iconClass = "far fa-file-video text-primary"; break;
                      case "word": iconClass = "far fa-file-word text-primary"; break;
                      case "excel": iconClass = "far fa-file-excel text-success"; break;
                      case "powerpoint": iconClass = "far fa-file-powerpoint text-warning"; break;
                      case "zip": iconClass = "far fa-file-archive text-secondary"; break;
                      case "text": iconClass = "far fa-file-alt text-dark"; break;
                      case "youtube": iconClass = "fab fa-youtube text-danger"; break;
                      case "vimeo": iconClass = "fab fa-vimeo text-primary"; break;
                      case "sway": iconClass = "fas fa-cloud text-info"; break;
                      case "embed": iconClass = "fas fa-code text-teal"; break;
                      default: iconClass = "far fa-file text-secondary";
                    }
                  }
 
                  const lessonItem = document.createElement("li");
                  lessonItem.classList.add("list-group-item");
 
                  const lessonHeader = document.createElement("button");
                  lessonHeader.classList.add("accordion-button", "collapsed", "d-flex", "justify-content-between");
                  lessonHeader.setAttribute("type", "button");
                  lessonHeader.setAttribute("data-bs-toggle", "collapse");
                  lessonHeader.setAttribute("data-bs-target", `#${lessonId}`);
                  lessonHeader.setAttribute("aria-expanded", "false");
                  lessonHeader.setAttribute("aria-controls", lessonId);
                  lessonHeader.innerHTML = `
                          <i class="${iconClass} me-2"></i> ${lesson.lesson}
                      `;
 
                      // Lesson Content
                  const lessonContent = document.createElement("div");
                  lessonContent.id = lessonId;
                  lessonContent.classList.add("accordion-collapse", "collapse");
                  lessonContent.setAttribute("aria-labelledby", lessonId);
                  lessonContent.setAttribute("data-bs-parent", `#${dayId}`);
 
                  const lessonBody = document.createElement("div");
                  lessonBody.classList.add("accordion-body");
                  lessonBody.innerHTML = `
                          <p><strong>Description:</strong> ${lesson.description || "No description available"}</p>
                          <a href="/viewModule/${lesson.module_id}" class="btn btn-primary btn-sm me-2"><i class="fas fa-eye"></i> View</a>
                           ${lesson.allow_download && lesson.file_url ? `
                            <a href="${lesson.file_url}" download class="btn btn-outline-secondary btn-sm me-2">
                              <i class="fas fa-download"></i> Download
                            </a>` : ''}
                          {% if is_teacher %}
                            <a href="/updateModule/${lesson.module_id}" class="btn btn-warning btn-sm me-2"><i class="fas fa-edit"></i> Edit</a>
                            <a href="/deleteModule/${lesson.module_id}" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</a>
                          {% endif %}
                      `;
 
                  lessonContent.appendChild(lessonBody);
                  lessonItem.appendChild(lessonHeader);
                  lessonItem.appendChild(lessonContent);
                  lessonList.appendChild(lessonItem);
 
                  if (lesson.activities && lesson.activities.length > 0) {
                    let activityListHTML = `<ul class="list-group mt-2">`;
                    lesson.activities.forEach(activity => {
                        let activityIcon = "fas fa-tasks text-secondary"; // Default icon
                        switch (activity.activity_type.toLowerCase()) {
                            case "assignment": activityIcon = "fas fa-file-alt text-primary"; break;
                            case "attendance": activityIcon = "fas fa-user-check text-success"; break;
                            case "participation": activityIcon = "fas fa-users text-danger"; break;
                            case "lesson": activityIcon = "fas fa-book-open text-dark"; break;
                            case "video conference": activityIcon = "fas fa-video text-info"; break;
                            case "quiz": activityIcon = "fas fa-pencil-alt text-warning"; break;
                            case "exam": activityIcon = "fas fa-file-signature text-purple"; break;
                            case "special activity": activityIcon = "fas fa-star text-secondary"; break;
                            case "url": activityIcon = "fas fa-link text-purple"; break;
                        }
                        activityListHTML += `
                            <li class="list-group-item d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="${activityIcon} text-primary me-3 fs-5"></i>
                                <div>
                                    <a href="/activity_detail/${activity.activity_id}/" class="fw-bold text-decoration-none">
                                        ${activity.activity_name}
                                    </a>
                                    <small class="d-block text-muted">
                                        <i class="fas fa-tag me-1"></i> ${activity.activity_type} 
                                        <i class="fas fa-clock ms-3 me-1"></i> ${activity.start_time || "TBD"} - ${activity.end_time || "TBD"}
                                    </small>
                                </div>
                            </div>
                            <a href="/activity_detail/${activity.activity_id}/" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </li>
                        `;
                    });
                    activityListHTML += `</ul>`;
                    lessonBody.innerHTML += `<p class="mb-2 mt-2"><strong>Activities:</strong></p>` + activityListHTML;
                }
 
                });
 
                dayBody.appendChild(lessonList);
                dayContent.appendChild(dayBody);
                dayHeader.appendChild(dayButton);
                dayItem.appendChild(dayHeader);
                dayItem.appendChild(dayContent);
                weekList.appendChild(dayItem);
              });
 
              weekBody.appendChild(weekList);
              weekContent.appendChild(weekBody);
              weekHeader.appendChild(weekButton);
 
              // ðŸ”¹ Add Teacher Evaluations Below the Week
              if (scheduleData.available_evaluations.length > 0) {
                const evaluationContainer = document.createElement("div");
                evaluationContainer.classList.add("list-group", "mt-3");
 
                const evaluationHeader = document.createElement("li");
                evaluationHeader.classList.add("list-group-item", "bg-secondary", "text-white", "font-weight-bold");
                evaluationHeader.textContent = "Teacher Evaluations";
                evaluationContainer.appendChild(evaluationHeader);
 
                scheduleData.available_evaluations.forEach(evaluation => {
                    const evaluationItem = document.createElement("li");
                    evaluationItem.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center");
 
                    evaluationItem.innerHTML = `
                        <span>
                            <i class="fas fa-user text-primary mr-2"></i> 
                            ${evaluation.teacher} (Survey)
                        </span>
                        <a href="/submit_evaluation/${evaluation.evaluation_id}/" class="btn btn-primary btn-sm">Take Survey</a>
                    `;
                    evaluationContainer.appendChild(evaluationItem);
                });
 
                weekContent.appendChild(evaluationContainer);
              }
 
              weekItem.appendChild(weekHeader);
              weekItem.appendChild(weekContent);
              lessonList.appendChild(weekItem);
            });
          });
      }
 
      function formatTime(timeRange) {
        if (!timeRange) return "N/A";  // Handle missing time cases
        const timeParts = timeRange.split(" to ");
        return `${convertTo12Hour(timeParts[0])} to ${convertTo12Hour(timeParts[1])}`;
      }
 
      function convertTo12Hour(timeString) {
        const [hours, minutes] = timeString.split(":");
        let period = "AM";
        let hour = parseInt(hours, 10);
 
        if (hour >= 12) {
          period = "PM";
          if (hour > 12) hour -= 12;
        }
        return `${hour}:${minutes} ${period}`;
      }
    });
  </script>
 
  <!-- Custom styles for lesson items -->
 
  {% comment %}classroom_mode code{% endcomment %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{% static 'js/classroom-mode.js' %}"></script>
  <script src="{% static 'js/classroom-mode.js' %}"></script>
  <script src="{% static 'js/classroom-mode-full-screen.js' %}"></script>
  <script src="{% static 'js/file-validation.js' %}"></script>
  <script src="{% static 'js/modal.js' %}"></script>
  <script src="{% static 'js/activate-classroom-mode.js' %}"></script>
{% endblock %}
