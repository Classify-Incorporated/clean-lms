{% load static %}
<nav class="navbar navbar-light navbar-glass navbar-top navbar-expand">
    <button class="btn navbar-toggler-humburger-icon navbar-toggler me-1 me-sm-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarVerticalCollapse" aria-controls="navbarVerticalCollapse" aria-expanded="false" aria-label="Toggle Navigation"><span class="navbar-toggle-icon"><span class="toggle-line"></span></span></button>
    <a class="navbar-brand me-1 me-sm-3" href="index.html">
        <div class="d-flex align-items-center"><img class="me-2" src="{% static 'assets/img/ched.png' %}" alt="" width="40" /><span class="font-sans-serif text-primary">{{ SCHOOL_SHORT_NAME }}</span>
        </div>
    </a>
    <ul class="navbar-nav align-items-center d-none d-lg-block">
        <li class="nav-item">
            <div class="search-box" data-list='{"valueNames":["title"]}'>
                <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                    <input class="form-control search-input fuzzy-search" type="search" placeholder="Search..." aria-label="Search" />
                    <span class="fas fa-search search-box-icon"></span>

                </form>
                <div class="btn-close-falcon-container position-absolute end-0 top-50 translate-middle shadow-none" data-bs-dismiss="search">
                    <button class="btn btn-link btn-close-falcon p-0" aria-label="Close"></button>
                </div>
            </div>
        </li>
    </ul>
    <ul class="navbar-nav navbar-nav-icons ms-auto flex-row align-items-center">
        <li class="nav-item d-flex align-items-center">
            <label class="switch">
                <input type="checkbox" id="themeSwitch">
                <div class="sun">
                    <div class="moon"></div>
                </div>
            </label>
        </li>
        
        
        <style>
            .switch {
                display: block;
                width: 40px;  /* Adjusted to fit navbar size */
                height: 25px; /* Adjusted to fit navbar size */
                background-color: #8af;
                border-radius: 500px;
                position: relative;
                overflow: hidden;
                transition: 0.3s;
                scale: 1;  /* Remove the large scale */
                margin-top: 8px;
                margin-right: 10px;
            }
            
            .switch::before {
                content: '';
                position: absolute;
                width: 15px;
                height: 15px;
                border-radius: 50%;
                background-color: #fff;
                right: 0;
                top: 0;
                bottom: 0;
                margin: auto;
                transform: translate(50%, 0%);
                transition: 0.3s;
                box-shadow: -5px 7px 0px 0px #fff, -15px 12px 0px 0px #fff, -23px 15px 0px 0px #fff,
                            -8px 5px 0px 0px #b3c9ff, -18px 9px 0px 0px #b3c9ff, -24px 14px 0px 0px #b3c9ff;
            }
            
            .switch::after {
                content: '';
                border-radius: 500px;
                position: absolute;
                inset: 0;
                box-shadow: 0px -2px #00000066 inset;
                z-index: 1;
                transition: 0.3s;
            }
            
            .switch input {
                display: none;
            }
            
            .sun {
                position: absolute;
                inset: 3px;
                height: calc(100% - 6px);
                aspect-ratio: 1/1;
                background-color: #fa0;
                border-radius: 50%;
                box-shadow: 0 0 0 4px #ffffff33, 0 0 0 8px #ffffff33, 2px 2px 2px 0px #ffffff80 inset,
                            -2px -2px 2px 0px #6a380380 inset;
                overflow: hidden;
                transition: 0.3s ease-in-out;
            }
            
            .switch input:checked + .sun {
                inset: 3px 3px 3px calc(100% - 22px);
            }
            
            .moon {
                position: absolute;
                inset: 0 0 0 100%;
                background-color: #d2d6de;
                border-radius: 50%;
                transition: 0.3s;
                box-shadow: 2px 2px 2px 0px #ffffff inset, -2px -2px 2px 0px #22222280 inset;
                background-image: radial-gradient(circle, #aeb4c1 2px, #0000 0px),
                                  radial-gradient(circle, #8c99a4 3px, #0000 0px);
                background-size: 8px 8px;
                background-repeat: no-repeat;
                background-position: 5px 8px, 12px 2px;
            }
            
            .switch:has(input:checked) {
                background-color: #2f3467;
            }
            
            .switch:has(input:checked)::after {
                box-shadow: 0px -2px 0px #ffffff80 inset;
            }
            
            .switch:has(input:checked) .moon {
                inset: 0;
            }
            
            .switch:has(input:checked)::before {
                right: -100%;
            }
            
        </style>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const themeSwitch = document.getElementById("themeSwitch");
        
                // Function to apply theme instantly
                function applyTheme(theme, updateSwitch = true) {
                    if (theme === "dark") {
                        document.documentElement.setAttribute("data-bs-theme", "dark");
                        document.body.classList.add("bg-dark", "text-white");
                        if (updateSwitch) themeSwitch.checked = true;
                    } else {
                        document.documentElement.setAttribute("data-bs-theme", "light");
                        document.body.classList.remove("bg-dark", "text-white");
                        if (updateSwitch) themeSwitch.checked = false;
                    }
                }
        
                // Load stored theme preference
                const savedTheme = localStorage.getItem("theme") || "light";
                applyTheme(savedTheme, true);
        
                // Listen for switch toggle
                themeSwitch.addEventListener("change", function () {
                    const newTheme = this.checked ? "dark" : "light";
                    localStorage.setItem("theme", newTheme);
                    applyTheme(newTheme, false);
                });
            });
        </script>
        <li class="nav-item dropdown">
            <a class="nav-link px-0
                      {% if unread_messages_count > 0 %}
                          notification-indicator notification-indicator-danger notification-indicator-fill
                      {% endif %}
                      fa-icon-wait"
               id="navbarDropdownMessages"
               role="button"
               data-bs-toggle="dropdown"
               aria-haspopup="true"
               aria-expanded="false"
               data-hide-on-body-scroll="data-hide-on-body-scroll">

                <span class="fas fa-comment-alt" data-fa-transform="shrink-6" style="font-size: 33px;"></span>

                {% if unread_messages_count > 0 %}
                    <span class="notification-indicator-number">{{ unread_messages_count }}</span>
                {% endif %}
            </a>

            <div class="dropdown-menu dropdown-caret dropdown-menu-end dropdown-menu-card dropdown-menu-notification dropdown-caret-bg" aria-labelledby="navbarDropdownMessages">
                <div class="card card-notification shadow-none">
                    <div class="card-header">
                        <div class="row justify-content-between align-items-center">
                            <div class="col-auto">
                                <h6 class="card-header-title mb-0">Message Center</h6>
                            </div>
                            <div class="col-auto ps-0 ps-sm-3">
                                <a class="card-link fw-normal mark-all-read" href="#">Mark all as read</a>
                            </div>
                        </div>
                    </div>
                
                    <div class="scrollbar-overlay" style="max-height:19rem">
                        <div class="list-group list-group-flush fw-normal fs-10" id="messageDropdownList">
                            <!-- Will be filled by WebSocket -->
                            <p class="dropdown-item text-center small text-gray-500 no-messages">
                                <i class="fas fa-inbox"></i> No new messages.
                            </p>
                        </div>
                    </div>                    
                
                    <div class="card-footer text-center border-top">
                        <a class="card-link d-block" href="{% url 'social_media_inbox' %}">View all messages</a>
                    </div>
                </div>                
            </div>
        </li>



        {% if show_logs %}
            <li class="nav-item dropdown">
                <a class="nav-link px-0
                          {% if unread_notifications_count > 0 %}
                              notification-indicator notification-indicator-primary notification-indicator-fill
                          {% endif %}
                          fa-icon-wait"
                   id="navbarDropdownNotification"
                   role="button"
                   data-bs-toggle="dropdown"
                   aria-haspopup="true"
                   aria-expanded="false"
                   data-hide-on-body-scroll="data-hide-on-body-scroll">

                    <span class="fas fa-bell" data-fa-transform="shrink-6" style="font-size: 33px;"></span>

                    {% if unread_notifications_count > 0 %}
                        <span class="notification-indicator-number">{{ unread_notifications_count }}</span>
                    {% endif %}
                </a>

                <div class="dropdown-menu dropdown-caret dropdown-menu-end dropdown-menu-card dropdown-menu-notification dropdown-caret-bg" aria-labelledby="navbarDropdownNotification">
                    <div class="card card-notification shadow-none">
                        <div class="card-header">
                            <div class="row justify-content-between align-items-center">
                                <div class="col-auto">
                                    <h6 class="card-header-title mb-0">Notifications</h6>
                                </div>
                                <div class="col-auto ps-0 ps-sm-3">
                                    <a class="card-link fw-normal" href="#">Mark all as read</a>
                                </div>
                            </div>
                        </div>

                        <div class="scrollbar-overlay" style="max-height:19rem">
                            <div class="list-group list-group-flush fw-normal fs-10">

                                {% if unread_notifications_count > 0 %}
                                    <div class="list-group-title border-bottom">NEW</div>
                                {% else %}
                                    <div class="list-group-item text-center">
                                        <p class="mb-1">No new notifications</p>
                                    </div>
                                {% endif %}

                          <!-- Combined Notifications -->
                            {% for entry in notifications %}
                                <a href="#" class="dropdown-item d-flex align-items-start {% if entry.is_read %}read-log{% else %} unread-log{% endif %}" 
                                    data-log-id="{{ entry.id }}">
                                    <div class="notification-avatar">
                                        <div class="avatar avatar-2xl me-3">
                                            <img class="rounded-circle" src="{% static 'assets/img/profile_default.png' %}" alt="User Image">
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <span class="d-block text-wrap">{{ entry.message }}</span>
                                        <i class="fas fa-bell me-2"></i>
                                        <small class="text-muted">{{ entry.created_at|timesince }} ago</small>
                                    </div>
                                </a>
                            {% empty %}
                            {% endfor %}
                            </div>
                        </div>

                        <div class="card-footer text-center border-top">
                            <a class="card-link d-block" href="{% url 'SubjectList' %}">View all</a>
                        </div>
                    </div>
                </div>
            </li>
        {% endif %}

        <li class="nav-item dropdown"><a class="nav-link pe-0 ps-2" id="navbarDropdownUser" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <div class="avatar avatar-xl status-online">
                <img class="rounded-circle img-fluid"
                     src="{% if request.user.profile.student_photo %}
                              {{ request.user.profile.student_photo.url }}
                          {% else %}
                              {% static 'assets/img/profile_default.png' %}
                          {% endif %}"
                     alt="User Image"
                     style="width: 100%; height: 100%; object-fit: cover;" />
            </div>
        </a>
            <div class="dropdown-menu dropdown-caret dropdown-menu-end py-0 w-100" aria-labelledby="navbarDropdownUser" style="min-width: 260px;">
                <div class="bg-white dark__bg-1000 rounded-2 py-2">
            <!-- Dropdown Header -->
                    <div class="px-3 py-2 text-center border-bottom">
                        <div class="d-flex flex-column align-items-center w-100">
                            <div>
                                <h6 class="mb-0">{{ request.user.get_full_name }}</h6>
                                <small class="text-muted">{{ request.user.profile.role }}</small>
                            </div>
                        </div>
                    </div>

                    <a class="dropdown-item d-flex align-items-center" href="{% url 'view_profile_header' request.user.id %}">
                        <i class="fas fa-user me-2"></i> My Profile
                    </a>
                    <div class="dropdown-divider"></div>

                    <a class="dropdown-item d-flex align-items-center text-danger" href="{% url 'sign_out' %}">
                        <i class="fas fa-sign-out-alt me-2"></i> Sign Out
                    </a>
                </div>
            </div>
        </li>
    </ul>
</nav>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const userId = "{{ request.user.id }}";
        if (!userId) return;
    
        const socket = new WebSocket(`ws://${window.location.host}/ws/notify/`);

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
        
            if (data.type === "notify_message") {
                const msgIcon = document.getElementById("navbarDropdownMessages");
                let notifNumber = msgIcon.querySelector(".notification-indicator-number");
        
                // 🔔 Update badge count
                if (notifNumber) {
                    notifNumber.textContent = parseInt(notifNumber.textContent || "0") + 1;
                } else {
                    notifNumber = document.createElement("span");
                    notifNumber.className = "notification-indicator-number";
                    notifNumber.textContent = 1;
                    msgIcon.appendChild(notifNumber);
                }
        
                msgIcon.classList.add("notification-indicator", "notification-indicator-danger", "notification-indicator-fill");
        
                const dropdownList = document.getElementById("messageDropdownList");
                const emptyMsg = dropdownList.querySelector('.no-messages');
                if (emptyMsg) emptyMsg.remove();

                const existing = dropdownList.querySelector(`[data-sender-id="${data.sender_id}"]`);

                if (existing) {
                    // ✅ Update content, time, and move to top
                    const messageText = existing.querySelector('.message-text');
                    const countSpan = existing.querySelector('.unread-count');

                    const count = parseInt(countSpan?.dataset.count || "1") + 1;

                    messageText.innerHTML = `${data.message} <span class="unread-count" data-count="${count}">(${count})</span>`;
                    if (countSpan) {
                        countSpan.dataset.count = count;
                        countSpan.textContent = `(${count})`;
                    }

                    const time = existing.querySelector('.time-sent');
                    time.textContent = formatTime(data.timestamp || new Date());

                    existing.dataset.timestamp = data.timestamp;
                } else {
                    const item = document.createElement("div");
                    item.className = "dropdown-item d-flex flex-column text-white font-weight-bold mb-1";
                    item.dataset.senderId = data.sender_id;
                    item.dataset.timestamp = data.timestamp;
                    item.style.backgroundColor = "#14A44D";
        
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="text-truncate">
                                <strong class="me-2">${data.sender_name}</strong>
                                <span class="message-text">
                                    ${data.message} <span class="unread-count" data-count="${data.unread_count || 1}">(${data.unread_count || 1})</span>
                                </span>
                            </div>
                            <small class="text-light ms-2 time-sent">${formatTime(data.timestamp || new Date())}</small>
                        </div>
                    `;
        
                    item.addEventListener("click", () => {
                        const chatUrl = `{% url 'social_media_inbox' %}?chat_with=${data.sender_id}&chat_name=${encodeURIComponent(data.sender_name)}&chat_photo=${encodeURIComponent(data.sender_photo || '')}`;
                        window.location.href = chatUrl;
                    });                    

                    dropdownList.prepend(item);
                }

                // ✅ Reorder by timestamp
                const items = Array.from(dropdownList.querySelectorAll('.dropdown-item'));
                items.sort((a, b) => new Date(b.dataset.timestamp) - new Date(a.dataset.timestamp));
                items.forEach(item => dropdownList.appendChild(item));

                // ✅ Limit to 5 latest
                const maxItems = 5;
                for (let i = maxItems; i < items.length; i++) {
                    items[i].remove();
                }
            }
        };
        
        // 🕒 Format time as 8:00 a.m.
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase();
        }
    });
</script>

    